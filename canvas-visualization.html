<html>
<head>
</head>
<body>
    <canvas id="fire" height="200" width="500"></canvas>
<script>
var num = 0;
    var fire = document.getElementById("fire").getContext("2d");
    function doit() {
        var row = fire.createImageData(500, 1);
        
        for(var w = 0; w < 500 && num % 5 === 0; w++) {
            row.data[w * 4 + 0] = Math.round(Math.random() * 128);
            row.data[w * 4 + 1] = Math.round(Math.random() * 256);
            row.data[w * 4 + 2] = Math.round(Math.random() * 128);
            row.data[w * 4 + 3] = Math.round(Math.random() * 256);
        }
        if(num % 5 === 0) { fire.putImageData(row, 0, 0); }
        //num++;
        for(var h = 199; h > 0; h--) {
            var prev = fire.getImageData(0, h - 1, 500, 1).data;
            var row = fire.getImageData(0, h, 500, 1);
            
            row.data[0] = (row.data[0] + 255 + prev[0] + prev[4]) >> 2;
            row.data[1] = (row.data[1] + 255 + prev[1] + prev[5]) >> 2;
            row.data[2] = (row.data[2] + 255 + prev[2] + prev[6]) >> 2;
            row.data[3] = (row.data[3] + 0 + prev[3] + prev[7]) >> 2;
            for(var w = 1; w < 499; w++) {
                var center = w * 4, left = (w - 1) * 4, right = (w + 1) * 4;
                var red   = row.data[w * 4 + 0] + prev[left + 0] + prev[center + 0] * 8 + prev[right + 0];
                var blue  = row.data[w * 4 + 1] + prev[left + 1] + prev[center + 1] * 8 + prev[right + 1];
                var green = row.data[w * 4 + 2] + prev[left + 2] + prev[center + 2] * 8 + prev[right + 2];
                var alpha = row.data[w * 4 + 3] + prev[left + 3] + prev[center + 3] * 8 + prev[right + 3];
                
                row.data[w * 4 + 0] = red   / 11;
                row.data[w * 4 + 1] = blue  / 11;
                row.data[w * 4 + 2] = green / 11;
                row.data[w * 4 + 3] = alpha / 11;
            }
            row.data[499 * 4 + 0] = (row.data[499 * 4 + 0] + prev[498 * 4 + 0] + prev[499 * 4 + 0] + 255) >> 2;
            row.data[499 * 4 + 1] = (row.data[499 * 4 + 1] + prev[498 * 4 + 1] + prev[499 * 4 + 1] + 255) >> 2;
            row.data[499 * 4 + 2] = (row.data[499 * 4 + 2] + prev[498 * 4 + 2] + prev[499 * 4 + 2] + 255) >> 2;
            row.data[499 * 4 + 3] = (row.data[499 * 4 + 3] + prev[498 * 4 + 3] + prev[499 * 4 + 3] + 0) >> 2;
            //debugger;
            fire.putImageData(row, 0, h);
            prev = row;
        }
        
        setTimeout(doit, 10);
    }
    
    setTimeout(doit, 50);
</script>
</body>
</html>
